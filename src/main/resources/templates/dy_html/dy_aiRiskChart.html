<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전기적 세부요인별 AI 위험점수 예측</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h2>지역별 전기적 세부요인별 위험점수 AI예측에 따른 요인별 감소기여도</h2>
    <label for="regionSelect">지역 선택:</label>
    <select id="regionSelect">
        <option value="">전체</option>
    </select>
    <canvas id="riskChart"></canvas>

    <script>
        $(document).ready(function () {
            let chart;
            const ctx = document.getElementById('riskChart').getContext('2d');
            let fullData = [];
            let excludedCauses = [];

            // ✅ **지역별 총 위험점수를 기준으로 정규화**
            function normalizeDataByRegion(data, region) {
                let regionData = region ? data.filter(d => d.Region === region) : data;
                let regionTotalRisk = regionData.reduce((sum, d) => sum + parseFloat(d["Reduction (%)"]), 0);

                console.log(`📌 [${region || "전체"}] 지역별 총 위험점수:`, regionTotalRisk);

                return regionData.map(d => ({
                    ...d,
                    "Reduction (%)": ((parseFloat(d["Reduction (%)"]) / regionTotalRisk) * 100).toFixed(2)
                }));
            }

            // ✅ **서버에서 데이터 가져오기**
            $.getJSON("/aiRisk/data", function (riskData) {
                fullData = riskData;
                populateSelect(fullData);
                updateChart(fullData, "", []);
            });

            function populateSelect(data) {
                let uniqueRegions = [...new Set(data.map(d => d.Region))];
                uniqueRegions.forEach(region => {
                    $("#regionSelect").append(`<option value="${region}">${region}</option>`);
                });
            }

            // ✅ **원인을 그룹화하여 중복 제거**
            function aggregateByCause(data, excludeCauses = []) {
                let grouped = {};
                data.forEach(d => {
                    if (excludeCauses.includes(d.Cause)) return;
                    if (!grouped[d.Cause]) {
                        grouped[d.Cause] = { Cause: d.Cause, Reduction: 0 };
                    }
                    grouped[d.Cause].Reduction += parseFloat(d["Reduction (%)"]);
                });

                return Object.values(grouped);
            }

            // ✅ **제거된 원인의 기여도를 남은 요인에 비례하여 재분배**
            function redistributeReduction(data, excludeCauses) {
                let filteredData = data.filter(d => !excludeCauses.includes(d.Cause));
                let remainingTotal = filteredData.reduce((sum, d) => sum + parseFloat(d.Reduction), 0);

                console.log("📌 제거된 원인 이후 총합 (재조정 전):", remainingTotal);

                return filteredData.map(d => ({
                    Cause: d.Cause,
                    Reduction: ((parseFloat(d.Reduction) / remainingTotal) * 100).toFixed(2)
                }));
            }

            // ✅ **차트 업데이트 (지역별 기준)**
            function updateChart(riskData, region, excludeCauses) {
                console.log("📌 차트 업데이트 시작", { region, excludeCauses });

                let normalizedData = normalizeDataByRegion(riskData, region);
                let aggregatedData = aggregateByCause(normalizedData, excludeCauses);

                if (excludeCauses.length > 0) {
                    aggregatedData = redistributeReduction(aggregatedData, excludeCauses);
                }

                aggregatedData.sort((a, b) => b.Reduction - a.Reduction);
                const labels = aggregatedData.map(d => d.Cause);
                const values = aggregatedData.map(d => d.Reduction);

                if (chart) {
                    chart.options.plugins.legend.onClick = null;
                    chart.destroy();
                }

                console.log("📌 차트 데이터", { labels, values });

                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '위험 감소 기여도',
                            data: values,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        onClick: (event, elements) => {
                            if (elements.length > 0 && elements[0] !== undefined) {
                                let index = elements[0].index;
                                let cause = chart.data.labels[index];

                                if (!excludedCauses.includes(cause)) {
                                    excludedCauses.push(cause);
                                    updateChart(fullData, $("#regionSelect").val(), excludedCauses);
                                }
                            }
                        },
                        scales: { 
                            y: { beginAtZero: true, max: 100 } 
                        }
                    }
                });
            }

            $("#regionSelect").change(function () {
                let selectedRegion = $(this).val();
                excludedCauses = [];
                updateChart(fullData, selectedRegion, excludedCauses);
            });
        });
    </script>
</body>
</html>
<!--  -->